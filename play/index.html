<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>HitPoint Dungeon</title>
  <style>
    html, body {
      margin: 0;
      background: #111;
      overflow: hidden;
    }
    canvas {
      display: block;
      margin: 0 auto;
      background: #111;
    }
    #musicToggle {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 24px;
      color: white;
      cursor: pointer;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div id="musicToggle">ðŸ”Š</div>
  <canvas id="gameCanvas" width="512" height="512"></canvas>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    let gridSize = 6;
    let tileSize = 64;
    let player = { x: 2, y: 2 };
    let enemies = [];
    let chests = [];

    const tilemap = new Image();
    const playerImg = new Image();
    const batImg = new Image();
    const chestImg = new Image();

    tilemap.src = "assets/tilemapfloor1to100.png";
    playerImg.src = "assets/playercharacter.png";
    batImg.src = "assets/goblintbat.png";
    chestImg.src = "assets/itemchestpickup.png";

    let tilemapOffsetX = 0;
    let tilemapOffsetY = 0;

    let currentFloor = 1;
    let hp = 10;
    let tier = 0;

    const musicTracks = ["renderme.mp3", "senderbeware.mp3"];
    let currentTrackIndex = 0;
    let musicEnabled = true;
    let currentMusic = null;

    const musicToggle = document.getElementById("musicToggle");
    musicToggle.addEventListener("click", () => {
      musicEnabled = !musicEnabled;
      musicToggle.style.color = musicEnabled ? "#eee" : "red";
      if (musicEnabled) {
        playMusic();
      } else if (currentMusic) {
        currentMusic.pause();
      }
    });

    function playMusic() {
      if (currentMusic) currentMusic.pause();
      const track = musicTracks[Math.floor((currentFloor - 1) / 100) % musicTracks.length];
      currentMusic = new Audio(`assets/${track}`);
      currentMusic.loop = true;
      if (musicEnabled) currentMusic.play();
    }

    function centerOffsets() {
      tilemapOffsetX = (canvas.width - gridSize * tileSize) / 2;
      tilemapOffsetY = (canvas.height - gridSize * tileSize) / 2;
    }

    function drawTilemap() {
      ctx.drawImage(tilemap, tilemapOffsetX - tileSize, tilemapOffsetY - tileSize);
    }

    function drawGrid() {
      for (let y = 0; y < gridSize; y++) {
        for (let x = 0; x < gridSize; x++) {
          ctx.strokeStyle = "rgba(255,255,255,0.1)";
          ctx.strokeRect(
            tilemapOffsetX + x * tileSize,
            tilemapOffsetY + y * tileSize,
            tileSize,
            tileSize
          );
        }
      }
    }

    function drawSprites() {
      ctx.drawImage(
        playerImg,
        tilemapOffsetX + player.x * tileSize,
        tilemapOffsetY + player.y * tileSize,
        tileSize,
        tileSize
      );
      enemies.forEach((e) => {
        ctx.drawImage(
          batImg,
          tilemapOffsetX + e.x * tileSize,
          tilemapOffsetY + e.y * tileSize,
          tileSize,
          tileSize
        );
      });
      chests.forEach((c) => {
        ctx.drawImage(
          chestImg,
          tilemapOffsetX + c.x * tileSize,
          tilemapOffsetY + c.y * tileSize,
          tileSize,
          tileSize
        );
      });
    }

    function drawHUD() {
      ctx.fillStyle = "white";
      ctx.font = "14px monospace";
      ctx.fillText(`Floor ${currentFloor} | HP: ${hp} | Tier: ${tier}`, 10, canvas.height - 10);
    }

    function drawGame() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawTilemap();
      drawGrid();
      drawSprites();
      drawHUD();
    }

    function movePlayer(dx, dy) {
      const newX = player.x + dx;
      const newY = player.y + dy;
      if (newX >= 0 && newX < gridSize && newY >= 0 && newY < gridSize) {
        player.x = newX;
        player.y = newY;
        handleEnemyTurn();
        drawGame();
      }
    }

    function handleEnemyTurn() {
      enemies.forEach((e) => {
        if (Math.random() < 0.5) {
          const dx = player.x > e.x ? 1 : player.x < e.x ? -1 : 0;
          const dy = player.y > e.y ? 1 : player.y < e.y ? -1 : 0;
          const targetX = e.x + dx;
          const targetY = e.y + dy;

          if (targetX === player.x && targetY === player.y) {
            hp--;
          } else if (
            !enemies.some((other) => other !== e && other.x === targetX && other.y === targetY)
          ) {
            e.x = targetX;
            e.y = targetY;

            // Chest steal
            const chestIndex = chests.findIndex((c) => c.x === e.x && c.y === e.y);
            if (chestIndex !== -1) {
              e.hasChest = true;
              chests.splice(chestIndex, 1);
            }
          }
        }
      });
    }

    function spawnFloor() {
      currentFloor++;
      player = { x: 2, y: 2 };
      enemies = [];
      chests = [];

      const enemyCount = 1 + Math.floor(Math.random() * 3);
      for (let i = 0; i < enemyCount; i++) {
        enemies.push({ x: rand(), y: rand(), hasChest: false });
      }

      const chestCount = 2 + Math.floor(Math.random() * 3);
      for (let i = 0; i < chestCount; i++) {
        chests.push({ x: rand(), y: rand() });
      }

      if ((currentFloor - 1) % 100 === 0) playMusic();

      drawGame();
    }

    function rand() {
      return Math.floor(Math.random() * gridSize);
    }

    document.addEventListener("keydown", (e) => {
      switch (e.key) {
        case "ArrowUp":
        case "w":
          movePlayer(0, -1);
          break;
        case "ArrowDown":
        case "s":
          movePlayer(0, 1);
          break;
        case "ArrowLeft":
        case "a":
          movePlayer(-1, 0);
          break;
        case "ArrowRight":
        case "d":
          movePlayer(1, 0);
          break;
        case " ":
          spawnFloor();
          break;
      }
    });

    window.onload = () => {
      centerOffsets();
      spawnFloor();
      playMusic();
    };
  </script>
</body>
</html>
