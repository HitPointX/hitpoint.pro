<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>HitPoint Dungeon</title>
  <style>
    body {
      margin: 0;
      background-color: #111;
      overflow: hidden;
    }
    #gameCanvas {
      display: block;
      margin: auto;
      background-color: #111;
    }
    #toast {
      position: absolute;
      top: 10px;
      left: 10px;
      padding: 6px 12px;
      background: rgba(0,0,0,0.7);
      border-radius: 4px;
      font-family: monospace;
      font-size: 14px;
      color: white;
      opacity: 0;
      transition: opacity 0.4s;
    }
    #speaker {
      position: absolute;
      top: 8px;
      right: 8px;
      font-size: 24px;
      cursor: pointer;
      filter: drop-shadow(0 0 2px #000);
      user-select: none;
      color: #ccc;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas" width="1024" height="768"></canvas>
  <div id="toast"></div>
  <div id="speaker">ðŸ”Š</div>
  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    const TILE_SIZE = 64;
    const GRID_WIDTH = 6;
    const GRID_HEIGHT = 6;

    const offsetX = (canvas.width - GRID_WIDTH * TILE_SIZE) / 2;
    const offsetY = (canvas.height - GRID_HEIGHT * TILE_SIZE) / 2;

    let player = { x: 3, y: 3, hp: 10 };
    let floor = 1;
    let tier = 0;
    let isGameOver = false;
    let musicMuted = false;
    let currentMusic = null;
    let currentTrackIndex = 0;
    const musicTracks = ["renderme.mp3", "senderbeware.mp3"];

    const speaker = document.getElementById("speaker");
    speaker.addEventListener("click", () => {
      musicMuted = !musicMuted;
      speaker.style.color = musicMuted ? "red" : "#ccc";
      if (currentMusic) currentMusic.volume = musicMuted ? 0 : 1;
    });

    const toastDiv = document.getElementById("toast");
    function toast(msg, color = "#ccc") {
      toastDiv.innerText = msg;
      toastDiv.style.color = color;
      toastDiv.style.opacity = 1;
      setTimeout(() => (toastDiv.style.opacity = 0), 1500);
    }

    function playMusic() {
      const track = musicTracks[currentTrackIndex];
      currentMusic = new Audio(`assets/${track}`);
      currentMusic.loop = true;
      currentMusic.volume = musicMuted ? 0 : 1;
      currentMusic.onerror = () => console.error("Audio failed to load:", track);
      currentMusic.play().catch(err => console.warn("Music playback error:", err));
    }

    function nextTrack() {
      currentTrackIndex = (currentTrackIndex + 1) % musicTracks.length;
      if (currentMusic) currentMusic.pause();
      playMusic();
    }

    const tileSprite = new Image();
    tileSprite.src = "assets/tilemapfloor1to100.png";

    const sprites = {
      player: new Image(),
      bat: new Image(),
      chest: new Image()
    };
    sprites.player.src = "assets/playercharacter.png";
    sprites.bat.src = "assets/goblintbat.png";
    sprites.chest.src = "assets/itemchestpickup.png";

    let enemies = [];
    let chests = [];

    function randPos() {
      return Math.floor(Math.random() * GRID_WIDTH);
    }

    function spawnStuff() {
      enemies = [];
      chests = [];
      for (let i = 0; i < Math.random() * 3 + 1; i++) {
        enemies.push({ x: randPos(), y: randPos(), carrying: null });
      }
      for (let i = 0; i < Math.random() * 3 + 2; i++) {
        chests.push({ x: randPos(), y: randPos() });
      }
    }

    function drawTile(x, y, sprite) {
      ctx.drawImage(sprite, offsetX + x * TILE_SIZE, offsetY + y * TILE_SIZE, TILE_SIZE, TILE_SIZE);
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(tileSprite, offsetX, offsetY, GRID_WIDTH * TILE_SIZE, GRID_HEIGHT * TILE_SIZE);

      chests.forEach(c => drawTile(c.x, c.y, sprites.chest));
      enemies.forEach(e => drawTile(e.x, e.y, sprites.bat));
      drawTile(player.x, player.y, sprites.player);

      ctx.font = "14px monospace";
      ctx.fillStyle = "white";
      ctx.fillText(`Floor ${floor} | HP: ${player.hp} | Tier: ${tier}`, offsetX, offsetY + GRID_HEIGHT * TILE_SIZE + 16);
    }

    function nextFloor() {
      floor++;
      if ((floor - 1) % 100 === 0 && floor !== 1) {
        nextTrack();
      }
      toast(`Floor ${floor} begins`, "#ccc");
      spawnStuff();
    }

    function movePlayer(dx, dy) {
      if (isGameOver) return;
      const newX = player.x + dx;
      const newY = player.y + dy;
      if (newX < 0 || newY < 0 || newX >= GRID_WIDTH || newY >= GRID_HEIGHT) return;

      player.x = newX;
      player.y = newY;

      let chestIndex = chests.findIndex(c => c.x === newX && c.y === newY);
      if (chestIndex !== -1) {
        toast("Found chest!", "yellow");
        chests.splice(chestIndex, 1);
      }

      let enemyIndex = enemies.findIndex(e => e.x === newX && e.y === newY);
      if (enemyIndex !== -1) {
        toast("You fight!", "red");
        player.hp -= 3;
        if (player.hp <= 0) {
          toast("You died!", "red");
          isGameOver = true;
          setTimeout(() => location.reload(), 2000);
          return;
        }
        if (enemies[enemyIndex].carrying) {
          chests.push({ x: newX, y: newY });
        }
        enemies.splice(enemyIndex, 1);
      }

      moveEnemies();
      draw();
    }

    function moveEnemies() {
      enemies.forEach(e => {
        if (Math.random() < 0.5) return;
        let dx = player.x > e.x ? 1 : player.x < e.x ? -1 : 0;
        let dy = player.y > e.y ? 1 : player.y < e.y ? -1 : 0;

        let nx = e.x + dx;
        let ny = e.y + dy;

        if (nx === player.x && ny === player.y) return;

        const chestIndex = chests.findIndex(c => c.x === nx && c.y === ny);
        if (chestIndex !== -1 && !e.carrying) {
          e.carrying = chests[chestIndex];
          chests.splice(chestIndex, 1);
        }

        e.x = Math.max(0, Math.min(GRID_WIDTH - 1, nx));
        e.y = Math.max(0, Math.min(GRID_HEIGHT - 1, ny));
      });
    }

    window.addEventListener("keydown", e => {
      switch (e.key) {
        case "ArrowUp":
        case "w": movePlayer(0, -1); break;
        case "ArrowDown":
        case "s": movePlayer(0, 1); break;
        case "ArrowLeft":
        case "a": movePlayer(-1, 0); break;
        case "ArrowRight":
        case "d": movePlayer(1, 0); break;
        case " ": nextFloor(); break;
      }
    });

    window.onload = () => {
      toast("Loading...", "#aaa");
      tileSprite.onload = () => {
        spawnStuff();
        draw();
        playMusic();
        toast("Welcome to HitPoint Dungeon!");
      };
    };
  </script>
</body>
</html>
